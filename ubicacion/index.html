<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localizar Ubicaci贸n</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Estilos locales -->
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/ubicacion.css">
</head>
<body>
    <h3>驴Qu茅 es geolocalizaci贸n?</h3>
                        <p>La geolocalizaci贸n es el proceso de identificar la posici贸n geogr谩fica real de un objeto, como un tel茅fono m贸vil, computadora o veh铆culo, mediante el uso de diferentes tecnolog铆as.</p>
                        <p>Esta tecnolog铆a utiliza coordenadas de latitud y longitud para determinar la ubicaci贸n exacta de un dispositivo en cualquier parte del mundo, permitiendo servicios basados en ubicaci贸n como mapas, navegaci贸n, y aplicaciones de entrega.</p>
                    </div>
                </div>

                <!-- Tipos de geolocalizaci贸n -->
                <div class="col-lg-6">
                    <div class="info-card">
                        <i class="bi bi-diagram-3-fill icon"></i>
                        <h3>Tipos de geolocalizaci贸n m谩s utilizados</h3>
                        <div class="tipo-geo">
                            <strong><i class="bi bi-broadcast me-2"></i>GPS (Global Positioning System)</strong>
                            <p class="mb-0 mt-2 small">Sistema satelital que ofrece la mayor precisi贸n (5-10 metros)</p>
                        </div>
                        <div class="tipo-geo">
                            <strong><i class="bi bi-wifi me-2"></i>WiFi</strong>
                            <p class="mb-0 mt-2 small">Utiliza redes WiFi cercanas para determinar ubicaci贸n (20-50 metros)</p>
                        </div>
                        <div class="tipo-geo">
                            <strong><i class="bi bi-phone me-2"></i>Red Celular</strong>
                            <p class="mb-0 mt-2 small">Triangulaci贸n mediante torres de telefon铆a m贸vil (100-1000 metros)</p>
                        </div>
                        <div class="tipo-geo">
                            <strong><i class="bi bi-router me-2"></i>Direcci贸n IP</strong>
                            <p class="mb-0 mt-2 small">Localizaci贸n aproximada basada en la direcci贸n IP (1-10 km)</p>
                        </div>
                        <div class="tipo-geo">
                            <strong><i class="bi bi-bluetooth me-2"></i>Bluetooth</strong>
                            <p class="mb-0 mt-2 small">Beacons para localizaci贸n en interiores (1-5 metros)</p>
                        </div>
                    </div>
                </div>

                <!-- 5 Aplicaciones -->
                <div class="col-lg-6">
                    <div class="info-card">
                        <i class="bi bi-app-indicator icon"></i>
                        <h3>5 Aplicaciones que utilizan geolocalizaci贸n</h3>
                        <div class="d-flex flex-wrap justify-content-center">
                            <div class="app-badge"><i class="bi bi-map me-2"></i><strong>Google Maps</strong> - Navegaci贸n y mapas</div>
                            <div class="app-badge"><i class="bi bi-car-front me-2"></i><strong>Uber / DiDi</strong> - Transporte compartido</div>
                            <div class="app-badge"><i class="bi bi-bag-heart me-2"></i><strong>Rappi / Uber Eats</strong> - Entrega de comida</div>
                            <div class="app-badge"><i class="bi bi-instagram me-2"></i><strong>Instagram</strong> - Etiquetado de ubicaci贸n</div>
                            <div class="app-badge"><i class="bi bi-cloud-sun me-2"></i><strong>Clima / Weather</strong> - Pron贸stico local</div>
                        </div>
                    </div>
                </div>

                <!-- 驴Qu茅 es una API? -->
                <div class="col-lg-6">
                    <div class="info-card">
                        <i class="bi bi-code-square icon"></i>
                        <h3>驴Qu茅 es una API?</h3>
                        <p><strong>API</strong> (Application Programming Interface) es un conjunto de reglas y protocolos que permite que diferentes aplicaciones de software se comuniquen entre s铆.</p>
                        <p>En t茅rminos simples, una API act煤a como un "mesero" entre dos sistemas: recibe solicitudes, las procesa y devuelve respuestas. Por ejemplo, cuando usas una app de clima, esta utiliza una API para obtener los datos meteorol贸gicos de un servidor.</p>
                        <div class="alert alert-info mt-3">
                            <strong>Ejemplo:</strong> La API de Geolocalizaci贸n del navegador permite que sitios web accedan a tu ubicaci贸n GPS con tu permiso.
                        </div>
                    </div>
                </div>

                <!-- C贸mo generar clave API -->
                <div class="col-12">
                    <div class="info-card">
                        <i class="bi bi-key-fill icon"></i>
                        <h3>驴C贸mo se genera una clave API?</h3>
                        <p>Una clave API es un c贸digo 煤nico que identifica y autentica tu aplicaci贸n cuando usa un servicio externo. Aqu铆 est谩 el proceso general:</p>
                        
                        <div class="row mt-4">
                            <div class="col-md-3 text-center mb-3">
                                <div class="step-badge">1</div>
                                <h5>Registro</h5>
                                <p class="small">Crea una cuenta en la plataforma del servicio (Google, OpenWeatherMap, etc.)</p>
                            </div>
                            <div class="col-md-3 text-center mb-3">
                                <div class="step-badge">2</div>
                                <h5>Acceder al panel</h5>
                                <p class="small">Inicia sesi贸n y busca la secci贸n "API Keys" o "Credenciales"</p>
                            </div>
                            <div class="col-md-3 text-center mb-3">
                                <div class="step-badge">3</div>
                                <h5>Crear proyecto</h5>
                                <p class="small">Algunos servicios requieren crear un proyecto antes de generar la clave</p>
                            </div>
                            <div class="col-md-3 text-center mb-3">
                                <div class="step-badge">4</div>
                                <h5>Generar clave</h5>
                                <p class="small">Haz clic en "Crear API Key" y copia el c贸digo generado</p>
                            </div>
                        </div>

                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-shield-lock-fill me-2"></i>
                            <strong>Importante:</strong> Nunca compartas tu clave API p煤blicamente. Gu谩rdala de forma segura y configura restricciones de uso para proteger tu cuenta.
                        </div>

                        <div class="mt-3">
                            <strong>Ejemplos de plataformas populares:</strong>
                            <ul class="mt-2">
                                <li><strong>Google Maps Platform:</strong> console.cloud.google.com</li>
                                <li><strong>OpenWeatherMap:</strong> openweathermap.org/api</li>
                                <li><strong>Mapbox:</strong> mapbox.com</li>
                                <li><strong>HERE Maps:</strong> developer.here.com</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-5 mb-5">
                <button class="btn btn-comenzar btn-lg" onclick="mostrarAplicacion()">
                    <i class="bi bi-geo-alt-fill me-2"></i>
                    Probar Localizador GPS
                </button>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card">
                    <div class="card-header text-center">
                        <i class="bi bi-geo-alt-fill" style="font-size: 50px;"></i>
                        <h1 class="mb-0 mt-3">Localizador de Ubicaci贸n</h1>
                        <p class="mb-0 mt-2 opacity-75">Encuentra tu posici贸n actual con GPS</p>
                    </div>
                    
                    <div class="card-body text-center p-5">
                        <div class="alert alert-info alert-custom mb-4" role="alert">
                            <i class="bi bi-lightbulb-fill me-2"></i>
                            <strong>Tip:</strong> Para mejor precisi贸n, activa el GPS y sal al exterior
                        </div>
                        
                        <button class="btn btn-primary btn-location" onclick="obtenerUbicacionUnaVez()">
                            <i class="bi bi-crosshair me-2"></i>
                            Ubicaci贸n actual
                        </button>
                        
                        <button class="btn btn-danger btn-watch" onclick="iniciarSeguimiento()" id="btnSeguimiento">
                            <i class="bi bi-radar me-2"></i>
                            Seguimiento GPS
                        </button>
                        
                        <div id="loading" class="mt-4" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-3 text-muted">Buscando se帽al GPS...</p>
                        </div>
                        
                        <div id="resultado"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    let watchId = null; // Para el seguimiento continuo
    let intentos = 0;
    let mejorPrecision = Infinity;
    let mejorUbicacion = null;

    // MTODO 1: Obtener ubicaci贸n una sola vez (con reintentos para mejorar)
    function obtenerUbicacionUnaVez() {
        if (!navigator.geolocation) {
            document.getElementById("resultado").innerHTML = `
                <div class="alert alert-danger alert-custom mt-4" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    La geolocalizaci贸n no est谩 soportada en este navegador.
                </div>
            `;
            return;
        }

        // Reiniciar variables
        intentos = 0;
        mejorPrecision = Infinity;
        mejorUbicacion = null;
        
        document.getElementById("loading").style.display = "block";
        document.getElementById("resultado").innerHTML = "";
        
        // Opciones de alta precisi贸n
        const opciones = {
            enableHighAccuracy: true,  // Forzar uso de GPS
            timeout: 15000,            // Esperar hasta 15 segundos
            maximumAge: 0              // No usar ubicaci贸n en cach茅
        };
        
        // Intentar m煤ltiples veces para mejorar precisi贸n
        obtenerConReintentos(opciones);
    }

    function obtenerConReintentos(opciones) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                intentos++;
                const precision = position.coords.accuracy;
                
                // Si esta ubicaci贸n es m谩s precisa, guardarla
                if (precision < mejorPrecision) {
                    mejorPrecision = precision;
                    mejorUbicacion = position;
                }
                
                // Si la precisi贸n es buena (menos de 20 metros) o ya hicimos 3 intentos
                if (precision < 20 || intentos >= 3) {
                    mostrarPosicion(mejorUbicacion);
                } else {
                    // Intentar de nuevo en 2 segundos
                    setTimeout(() => obtenerConReintentos(opciones), 2000);
                }
            },
            mostrarError,
            opciones
        );
    }

    // MTODO 2: Seguimiento continuo GPS (actualizaci贸n en tiempo real)
    function iniciarSeguimiento() {
        const btn = document.getElementById("btnSeguimiento");
        
        if (watchId !== null) {
            // Detener seguimiento
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
            btn.innerHTML = '<i class="bi bi-radar me-2"></i>Seguimiento GPS';
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-danger');
            document.getElementById("resultado").innerHTML += `
                <div class="alert alert-warning alert-custom mt-3" role="alert">
                    <i class="bi bi-pause-circle-fill me-2"></i>
                    Seguimiento detenido
                </div>
            `;
            return;
        }
        
        if (!navigator.geolocation) {
            alert("Tu navegador no soporta geolocalizaci贸n");
            return;
        }
        
        document.getElementById("loading").style.display = "block";
        document.getElementById("resultado").innerHTML = "";
        
        // Cambiar bot贸n a "Detener"
        btn.innerHTML = '<i class="bi bi-stop-circle me-2"></i>Detener';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-warning');
        
        // Opciones de alta precisi贸n
        const opciones = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        };
        
        // Iniciar seguimiento continuo
        watchId = navigator.geolocation.watchPosition(
            mostrarPosicionContinua,
            mostrarError,
            opciones
        );
    }

    function mostrarPosicionContinua(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const precision = position.coords.accuracy;
        const velocidad = position.coords.speed;
        const timestamp = new Date(position.timestamp);
        
        document.getElementById("loading").style.display = "none";
        
        // Enviar a PHP
        fetch('guardar_ubicacion.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({latitud: lat, longitud: lon})
        })
        .then(response => response.json())
        .then(data => {
            let nivelPrecision = '';
            let colorPrecision = '';
            
            if (precision < 20) {
                nivelPrecision = 'Excelente';
                colorPrecision = 'success';
            } else if (precision < 50) {
                nivelPrecision = 'Muy buena';
                colorPrecision = 'success';
            } else if (precision < 100) {
                nivelPrecision = 'Buena';
                colorPrecision = 'info';
            } else if (precision < 500) {
                nivelPrecision = 'Regular';
                colorPrecision = 'warning';
            } else {
                nivelPrecision = 'Baja';
                colorPrecision = 'danger';
            }
            
            document.getElementById("resultado").innerHTML = `
                <div class="resultado-card">
                    <h4 class="text-center mb-3">
                        <i class="bi bi-broadcast-pin text-danger me-2"></i>
                        Seguimiento activo
                        <span class="badge bg-danger ms-2">LIVE</span>
                    </h4>
                    
                    <div class="alert alert-${colorPrecision} alert-custom mb-3 text-center" role="alert">
                        <h5 class="mb-1">
                            <i class="bi bi-bullseye me-2"></i>
                            Precisi贸n: 卤${Math.round(precision)} metros
                        </h5>
                        <span class="badge badge-precision bg-${colorPrecision}">${nivelPrecision}</span>
                    </div>
                    
                    <div class="info-item d-flex align-items-center">
                        <i class="bi bi-geo-alt-fill me-3"></i>
                        <div class="flex-grow-1">
                            <small class="text-muted d-block">Latitud</small>
                            <strong>${lat.toFixed(7)}</strong>
                        </div>
                    </div>
                    
                    <div class="info-item d-flex align-items-center">
                        <i class="bi bi-geo-fill me-3"></i>
                        <div class="flex-grow-1">
                            <small class="text-muted d-block">Longitud</small>
                            <strong>${lon.toFixed(7)}</strong>
                        </div>
                    </div>
                    
                    <div class="info-item d-flex align-items-center">
                        <i class="bi bi-building me-3"></i>
                        <div class="flex-grow-1">
                            <small class="text-muted d-block">Ciudad</small>
                            <strong>${data.ciudad || 'Cargando...'}</strong>
                        </div>
                    </div>
                    
                    ${velocidad !== null ? `
                    <div class="info-item d-flex align-items-center">
                        <i class="bi bi-speedometer2 me-3"></i>
                        <div class="flex-grow-1">
                            <small class="text-muted d-block">Velocidad</small>
                            <strong>${(velocidad * 3.6).toFixed(1)} km/h</strong>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="info-item d-flex align-items-center">
                        <i class="bi bi-clock-fill me-3"></i>
                        <div class="flex-grow-1">
                            <small class="text-muted d-block">ltima actualizaci贸n</small>
                            <strong>${timestamp.toLocaleTimeString()}</strong>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <a href="https://www.google.com/maps?q=${lat},${lon}" 
                           target="_blank" 
                           class="btn-maps">
                            <i class="bi bi-map me-2"></i>
                            Ver en Google Maps
                        </a>
                    </div>
                </div>
            `;
        });
    }

    function mostrarPosicion(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const precision = position.coords.accuracy;
        
        fetch('guardar_ubicacion.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({latitud: lat, longitud: lon})
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById("loading").style.display = "none";
            
            let nivelPrecision = '';
            let colorPrecision = '';
            let recomendacion = '';
            
            if (precision < 20) {
                nivelPrecision = 'Excelente (GPS activo)';
                colorPrecision = 'success';
                recomendacion = '隆Ubicaci贸n muy precisa! ';
            } else if (precision < 50) {
                nivelPrecision = 'Muy buena (GPS)';
                colorPrecision = 'success';
                recomendacion = 'Buena precisi贸n con GPS';
            } else if (precision < 100) {
                nivelPrecision = 'Buena (WiFi/GPS)';
                colorPrecision = 'info';
                recomendacion = 'Precisi贸n aceptable';
            } else if (precision < 500) {
                nivelPrecision = 'Regular (WiFi/Red m贸vil)';
                colorPrecision = 'warning';
                recomendacion = 'Considera activar GPS para mayor precisi贸n';
            } else {
                nivelPrecision = 'Baja (IP/Red m贸vil)';
                colorPrecision = 'danger';
                recomendacion = '锔 Activa el GPS y sal al exterior para mejor precisi贸n';
            }
            
            document.getElementById("resultado").innerHTML = `
                <div class="resultado-card">
                    <h4 class="text-center mb-4">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        Ubicaci贸n obtenida
                    </h4>
                    
                    <div class="alert alert-${colorPrecision} alert-custom mb-3 text-center" role="alert">
                        <h5 class="mb-1">
                            <i class="bi bi-bullseye me-2"></i>
                            Precisi贸n: 卤${Math.round(precision)} metros
                        </h5>
                        <span class="badge badge-precision bg-${colorPrecision}">${nivelPrecision}</span>
                        <p class="mb-0 mt-2 small">${recomendacion}</p>
                    </div>
                    
                    <div class="info-item d-flex align-items-center">
                        <i class="bi bi-geo-alt-fill me-3"></i>
                        <div class="flex-grow-1">
                            <small class="text-muted d-block">Latitud</small>
                            <strong>${lat.toFixed(7)}</strong>
                        </div>
                    </div>
                    
                    <div class="info-item d-flex align-items-center">
                        <i class="bi bi-geo-fill me-3"></i>
                        <div class="flex-grow-1">
                            <small class="text-muted d-block">Longitud</small>
                            <strong>${lon.toFixed(7)}</strong>
                        </div>
                    </div>
                    
                    <div class="info-item d-flex align-items-center">
                        <i class="bi bi-building me-3"></i>
                        <div class="flex-grow-1">
                            <small class="text-muted d-block">Ciudad</small>
                            <strong>${data.ciudad || 'No disponible'}</strong>
                        </div>
                    </div>
                    
                    ${data.pais ? `
                    <div class="info-item d-flex align-items-center">
                        <i class="bi bi-flag-fill me-3"></i>
                        <div class="flex-grow-1">
                            <small class="text-muted d-block">Pa铆s</small>
                            <strong>${data.pais}</strong>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="text-center">
                        <a href="https://www.google.com/maps?q=${lat},${lon}" 
                           target="_blank" 
                           class="btn-maps">
                            <i class="bi bi-map me-2"></i>
                            Ver en Google Maps
                        </a>
                    </div>
                    
                    ${precision > 100 ? `
                    <div class="alert alert-warning alert-custom mt-3" role="alert">
                        <strong> Consejo:</strong> Usa el bot贸n "Seguimiento GPS" para obtener ubicaci贸n en tiempo real m谩s precisa
                    </div>
                    ` : ''}
                </div>
            `;
        })
        .catch(error => {
            document.getElementById("loading").style.display = "none";
            document.getElementById("resultado").innerHTML = `
                <div class="alert alert-warning alert-custom mt-4" role="alert">
                    <i class="bi bi-exclamation-circle-fill me-2"></i>
                    Error al procesar la ubicaci贸n. Por favor, intenta nuevamente.
                </div>
            `;
        });
    }

    function mostrarError(error) {
        document.getElementById("loading").style.display = "none";
        
        const mensajes = {
            1: "Permiso denegado. Por favor, permite el acceso a tu ubicaci贸n en la configuraci贸n del navegador.",
            2: "Ubicaci贸n no disponible. Verifica que tu GPS est茅 activado.",
            3: "Tiempo de espera agotado. Intenta nuevamente."
        };
        
        const iconos = {
            1: "bi-x-circle-fill",
            2: "bi-wifi-off",
            3: "bi-clock-fill"
        };
        
        document.getElementById("resultado").innerHTML = `
            <div class="alert alert-danger alert-custom mt-4" role="alert">
                <i class="bi ${iconos[error.code] || 'bi-exclamation-triangle-fill'} me-2"></i>
                <strong>Error:</strong> ${mensajes[error.code] || "Error desconocido"}
            </div>
        `;
    }
    </script>
</body>
</html>